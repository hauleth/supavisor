name: Staging Formatting Checks
on:
  pull_request:
    branches:
      - main
env:
  SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}
jobs:
  format:
    name: Formatting Checks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Setup elixir
        id: beam
        uses: erlef/setup-beam@v1
        with:
          otp-version: 25.x # Define the OTP version [required]
          elixir-version: 1.14.x # Define the elixir version [required]
      - name: Cache Mix
        uses: actions/cache@v1
        with:
          path: deps
          key: ${{ runner.os }}-mix-${{ hashFiles(format('{0}{1}', github.workspace, '/mix.lock')) }}
          restore-keys: |
            ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get
      - name: Set up Postgres
        run: docker-compose -f ./docker-compose.db.yml up -d
      - name: Run main database migrations
        run: mix ecto.migrate --prefix _supavisor --log-migrator-sql
      - name: Run pg bench
        run: PGPASSWORD=postgres pgbench -M extended --transactions 100 --jobs 10 --client 100 -h localhost -p 7654 -U postgres.localhost postgres
